@* Generator: Template TypeVisibility: Internal GeneratePrettyNames: True *@
@using System
@using System.Collections.Generic
@using System.Linq
@using Hangfire
@using Hangfire.Atoms
@using Hangfire.Atoms.Dashboard
@using Hangfire.Common
@using Hangfire.Dashboard
@using Hangfire.Dashboard.Pages
@using Hangfire.Dashboard.Resources
@using Hangfire.States
@inherits Hangfire.Dashboard.RazorPage
@{
    var monitor = Storage.GetMonitoringApi();
    var job = monitor.JobDetails(JobId);

    string title = null;

    if (job != null)
    {
        title = job.Job != null ? Html.JobName(job.Job) : null;
    }

    title = title ?? Strings.Common_Job;
    Layout = new LayoutPage(title);

    Dictionary<string, string> atomStates = null;
    using (var connection = Storage.GetJobStorageConnection())
    {
        atomStates = connection.GetAllEntriesFromHash(Atom.GenerateSubAtomKeys(JobId));
    }
    var jobDetails = monitor.JobDetails(JobId);

    var states = atomStates.Select(x =>
    {
        var subatomJobDetails = monitor.JobDetails(x.Key);
        var lastState = subatomJobDetails.History.First();

        return (x, subatomJobDetails, lastState);
    }).GroupBy(x => x.Item3.StateName).OrderBy(x => x.Key).ToList();

    var subatomsCount = atomStates.Count;
    var subatomsFinished = states.FirstOrDefault(x => x.Key == SucceededState.StateName)?.Count() ?? 0;
    var subatomsFinishedPercentage = Math.Round(subatomsFinished * 100.0M / subatomsCount, MidpointRounding.ToEven);
    var subatomsProcessing = states.FirstOrDefault(x => x.Key == ProcessingState.StateName)?.Count() ?? 0;
    var subatomsProcessingPercentage = Math.Floor(subatomsProcessing * 100.0M / subatomsCount);
    var subatomsFailed = states.FirstOrDefault(x => x.Key == FailedState.StateName)?.Count() ?? 0;
    var subatomsFailedPercentage = Math.Floor(subatomsFailed * 100.0M / subatomsCount);
}

<div class="row">
    <div class="col-md-3">
        @Html.JobsSidebar()
    </div>
    <div class="col-md-9">
        <h1 class="page-header">@title</h1>

        @if (job == null)
        {
            <div class="alert alert-warning">
                @String.Format(Strings.JobDetailsPage_JobExpired, JobId)
            </div>
        }
        else
        {
            if (job.ExpireAt.HasValue)
            {
                <div class="alert alert-info">
                    @Html.Raw(String.Format(Strings.JobDetailsPage_JobFinished_Warning_Html, JobHelper.ToTimestamp(job.ExpireAt.Value), job.ExpireAt))
                </div>
            }

            <div class="job-snippet">
                <div class="job-snippet-code">
                    <dl class="dl-horizontal">
                        <dt>@Strings.Common_Id</dt>
                        <dd>@Url.JobIdLink(JobId)</dd>
                        <dt>@Strings.NavigationMenu_Jobs</dt>
                        <dd>@subatomsCount</dd>
                        @if (subatomsProcessing != 0)
                        {
                            <dt>@Strings.JobsSidebarMenu_Processing</dt>
                            <dd>@subatomsProcessing</dd>
                        }
                        <dt>Progress</dt>
                        <dd>
                            <div class="progress">
                                <div class="progress-bar progress-bar-success" role="progressbar" style="width: @subatomsFinishedPercentage%;">
                                    @subatomsFinishedPercentage%
                                </div>
                                <div class="progress-bar progress-bar-danger" role="progressbar" style="width: @subatomsFailedPercentage%;">
                                </div>
                                <div class="progress-bar progress-bar-warning progress-bar-striped active" role="progressbar" style="width: @subatomsProcessingPercentage%;">
                                </div>
                            </div>
                        </dd>
                    </dl>

                </div>
            </div>

            var index = 0;
            <ul class="nav nav-tabs nav-justified" role="tablist">
                @foreach (var state in states)
                {
                    var stateBackgroundColor = JobHistoryRenderer.GetForegroundStateColor(state.Key);
                    var stateId = state.Key.ToLowerInvariant().Replace(" ", "");
                    <li role="presentation" class="@(index == 0 ? "active" : "")">
                        <a href="#@stateId" aria-controls="@stateId" role="tab" data-toggle="tab">
                            @state.Key <span class="badge" style="background-color: @stateBackgroundColor">@state.Count()</span>
                        </a>
                    </li>
                    index++;
                }
            </ul>

            index = 0;
            <div class="tab-content">
                @foreach (var state in states)
                {
                    var stateId = state.Key.ToLowerInvariant().Replace(" ", "");
                    <div role="tabpanel" class="tab-pane @(index == 0 ? "active" : "")" id="@stateId">
                        <div class="panel panel-default" style="border-top: none;">
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="min-width word-break">@Strings.Common_Id</th>
                                                <th>@Strings.Common_Job</th>
                                                <th class="min-width word-break">@Strings.Common_Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var subAtomState in state)
                                            {
                                                <tr>
                                                    @{
                                                        var subatomJobDetails = subAtomState.Item2;
                                                        var lastState = subAtomState.Item3;
                                                    }

                                                    <td class="min-width word-break">@Html.JobIdLink(subAtomState.Item1.Key)</td>
                                                    <td>@Html.JobNameLink(subAtomState.Item1.Key, subatomJobDetails.Job)</td>
                                                    <td class="min-width word-break">@Html.RelativeTime(lastState.CreatedAt)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    index++;
                }
            </div>
        }
    </div>
</div>
